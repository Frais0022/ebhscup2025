<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>REMI OYEBADE Interhouse Football</title>
<style>
<div class="card">
  <div class="flex" style="justify-content:space-between;align-items:center">
    <div class="small muted">Shareable link: <code id="shareLink"></code></div>
    <div id="countdown" class="small muted"></div>
  </div>
</div>

<div class="card">
  <h3>Team Slots — Representatives Claim Here</h3>
  <div id="slotsRow" class="flex"></div>
  <div style="margin-top:10px"><button id="generateBtn" onclick="generateFixtures()" disabled>Generate Semi-Final Fixtures</button></div>
</div>

<div class="card" id="fixturesCard" style="display:none">
  <h3>Semi-Finals</h3>
  <div id="fixtures"></div>
</div>

<div class="card" id="finalCard" style="display:none">
  <h3>Final</h3>
  <div id="finals"></div>
</div>

<div class="card">
  <h3>Per-match Leaderboards</h3>
  <div id="matchLeaderboards"></div>
</div>

<div class="card">
  <h3>Competition Scorers Ranking</h3>
  <div id="globalLeaderboardTable"></div>
</div>

<div class="card small">
  <label>Admin actions (password required)</label>
  <input id="adminPass" type="password" placeholder="Admin password (REMI2025)" />
  <div style="margin-top:8px;display:flex;gap:8px">
    <button onclick="resetEverything()" class="secondary">Reset All Data</button>
    <button onclick="forceFetch()">Sync Now</button>
  </div>
  <div id="status"></div>
  <div id="error"></div>
</div>

<script>
/* CONFIG */
const BIN_ID = "6935e85143b1c97be9de3eb2";
const API_KEY = "$2a$10$ez2mNhQs2BylwsUGJgfaceuUHDJnBUnWu6mwdgavcko3ZQTMXyKlG";
const ADMIN_PASSWORD = "REMI2025";
const POLL_MS = 5000;
const COMP_DATE = new Date("December 8, 2025 08:30:00").getTime();

let remoteData = null;
let pushing = false;

/* Helpers */
function setStatus(msg, isError=false){
  document.getElementById("status").textContent = isError ? "" : msg;
  document.getElementById("error").textContent = isError ? msg : "";
}
function shareLinkUpdate(){
  const u = new URL(location.href);
  if(!u.searchParams.get('comp')) u.searchParams.set('comp','EBHS2025');
  history.replaceState({},'',u.toString());
  document.getElementById('shareLink').textContent = u.toString();
}
function escapeHtml(s){ if(!s) return ""; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* Countdown */
function updateCountdown(){
  const el = document.getElementById('countdown');
  const diff = COMP_DATE - Date.now();
  if(diff <= 0){ el.textContent = "Competition is LIVE!"; return; }
  const d = Math.floor(diff/(1000*60*60*24));
  const h = Math.floor((diff%(1000*60*60*24))/(1000*60*60));
  const m = Math.floor((diff%(1000*60*60))/(1000*60));
  const s = Math.floor((diff%(1000*60))/1000);
  el.textContent = `Starts: ${d}d ${h}h ${m}m ${s}s`;
}
setInterval(updateCountdown,1000);
updateCountdown();
shareLinkUpdate();

/* JSONBin fetch/push */
async function fetchRemote(){
  try{
    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
      headers: { "X-Master-Key": API_KEY }
    });
    if(!res.ok) throw new Error("Failed to fetch JSONBin data");
    const data = await res.json();
    remoteData = normalize(data.record);
    saveLocal(remoteData);
    renderAll();
    setStatus(`Synced: ${new Date().toLocaleTimeString()}`);
  }catch(err){
    console.error(err);
    setStatus("Fetch failed from JSONBin", true);
  }
}
async function pushUpdate(payload){
  if(pushing) return;
  pushing = true;
  setStatus("Pushing update...");
  try{
    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
      method:"PUT",
      headers:{
        "Content-Type":"application/json",
        "X-Master-Key": API_KEY
      },
      body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error("Push failed " + res.status);
    remoteData = normalize(payload);
    saveLocal(remoteData);
    renderAll();
    setStatus("Update pushed: " + new Date().toLocaleTimeString());
  }catch(err){
    console.error(err);
    setStatus("Push failed: "+err.message,true);
  } finally{ pushing=false; }
}

/* Local storage fallback */
function saveLocal(d){ localStorage.setItem("comp_shared", JSON.stringify(d)); }
function loadLocal(){ try{ return normalize(JSON.parse(localStorage.getItem("comp_shared")||"null")); }catch(e){ return normalize(null);} }
function normalize(d){
  if(!d) d = {};
  d.teams = Array.isArray(d.teams) && d.teams.length===4 ? d.teams : [{name:"",logo:""},{name:"",logo:""},{name:"",logo:""},{name:"",logo:""}];
  d.fixtures = d.fixtures || { semi:null, final:null, winners:["",""], scores:[[0,0],[0,0]], chat:[[],[]], finalScore:[0,0], finalChat:[] };
  d.fixtures.chat = d.fixtures.chat || [[],[]];
  d.fixtures.finalChat = d.fixtures.finalChat || [];
  return d;
}

/* Start polling */
fetchRemote();
setInterval(fetchRemote, POLL_MS);
const cached = loadLocal();
if(cached){ remoteData = cached; renderAll(); }

/* UI & Logic */
function renderAll(){
  const data = remoteData || loadLocal();
  renderSlots(data.teams);
  renderFixturesUI(data.fixtures);
  renderLeaderboards(data);
  checkGenerateEnabled();
}

function renderSlots(teams){
  const row = document.getElementById("slotsRow");
  row.innerHTML = "";
  teams.forEach((t,i)=>{
    const div = document.createElement("div");
    div.className = "slot";
    if(!t.name){
      div.innerHTML = `<div style="font-weight:600">Slot ${i+1}</div>
        <input id="teamName${i}" placeholder="Team / House name" />
        <input id="teamLogoFile${i}" type="file" accept="image/*" />
        <button onclick="claimSlot(${i})">Claim Slot</button>`;
    } else {
      const logo = t.logo ? `<img class="logo" src="${t.logo}" alt="logo">` : "";
      div.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between">
        <div><strong>Slot ${i+1}</strong><div style="font-weight:600">${escapeHtml(t.name)}</div></div>
        <div>${logo}</div>
      </div>`;
    }
    row.appendChild(div);
  });
}

function claimSlot(index){
  const nameEl = document.getElementById(`teamName${index}`);
  if(!nameEl) return alert("Input missing");
  const name = nameEl.value.trim();
  if(!name) return alert("Enter team name");
  const file = document.getElementById(`teamLogoFile${index}`);
  if(file && file.files && file.files[0]){
    const reader = new FileReader();
    reader.onload = e => applyLocalClaim(index, name, e.target.result);
    reader.readAsDataURL(file.files[0]);
  } else { applyLocalClaim(index,name,""); }
}

function applyLocalClaim(index,name,logo){
  if(!remoteData) remoteData = loadLocal();
  remoteData.teams[index] = {name,logo};
  saveLocal(remoteData);
  renderAll();
  pushUpdate(remoteData);
}

function checkGenerateEnabled(){
  const data = remoteData || loadLocal();
  const ok = data.teams.every(t => t.name && t.name.trim()!=="");
  document.getElementById("generateBtn").disabled = !ok;
}

function generateFixtures(){
  if(!remoteData) remoteData = loadLocal();
  const teams = [...remoteData.teams];
  for(let i=teams.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [teams[i],teams[j]]=[teams[j],teams[i]]; }
  remoteData.fixtures = { semi:[{team1:teams[0],team2:teams[1]},{team1:teams[2],team2:teams[3]}], final:null, winners:["",""], scores:[[0,0],[0,0]], chat:[[],[]], finalScore:[0,0], finalChat:[] };
  saveLocal(remoteData);
  renderAll();
  pushUpdate(remoteData);
}

/* Parse scorers string into array */
function parseScorersList(text){
  if(!text) return [];
  const parts = text.replace(/\n/g,',').split(/[,;]+/).map(s=>s.trim()).filter(Boolean);
  return parts.map(p=>{
    const m=p.match(/^(.+?)[\s:\-]+(\d+)$/);
    return m ? {scorer:m[1].trim(), goals:parseInt(m[2],10)} : {scorer:p, goals:1};
  });
}

/* Save match */
function saveMatch(idx){
  const pass = document.getElementById(`adminPassMatch_${idx}`).value;
  if(pass!==ADMIN_PASSWORD){ alert("Wrong admin password"); return; }
  const sA = parseInt(document.getElementById(`scoreA_${idx}`).value)||0;
  const sB = parseInt(document.getElementById(`scoreB_${idx}`).value)||0;
  const parsed = parseScorersList(document.getElementById(`scorersList_${idx}`).value||"");
  remoteData.fixtures.scores[idx] = [sA,sB];
  remoteData.fixtures.chat[idx] = parsed.map(p=>({ time: new Date().toLocaleTimeString(), scorer:p.scorer, goals:p.goals }));

  // Update winners & final
  const [s0,s1] = remoteData.fixtures.scores[0];
  const [s2,s3] = remoteData.fixtures.scores[1];
  remoteData.fixtures.winners[0]=s0>s1 ? remoteData.fixtures.semi[0].team1.name : s1>s0 ? remoteData.fixtures.semi[0].team2.name :"";
  remoteData.fixtures.winners[1]=s2>s3 ? remoteData.fixtures.semi[1].team1.name : s3>s2 ? remoteData.fixtures.semi[1].team2.name :"";
  if(remoteData.fixtures.winners[0] && remoteData.fixtures.winners[1]){
    const t1=(remoteData.fixtures.semi[0].team1.name===remoteData.fixtures.winners[0]?remoteData.fixtures.semi[0].team1:remoteData.fixtures.semi[0].team2);
    const t2=(remoteData.fixtures.semi[1].team1.name===remoteData.fixtures.winners[1]?remoteData.fixtures.semi[1].team1:remoteData.fixtures.semi[1].team2);
    remoteData.fixtures.final={team1:t1,team2:t2}; remoteData.fixtures.finalScore=[0,0]; remoteData.fixtures.finalChat=[];
  } else { remoteData.fixtures.final=null; remoteData.fixtures.finalScore=[0,0]; remoteData.fixtures.finalChat=[]; }

  saveLocal(remoteData); renderAll(); pushUpdate(remoteData);
}

/* Save final */
function saveFinal(){
  const pass=document.getElementById("adminPassFinal").value;
  if(pass!==ADMIN_PASSWORD){ alert("Wrong admin password"); return; }
  const sA=parseInt(document.getElementById("finalScoreA").value)||0;
  const sB=parseInt(document.getElementById("finalScoreB").value)||0;
  const parsed=parseScorersList(document.getElementById("finalScorersList").value||"");
  remoteData.fixtures.finalScore=[sA,sB];
  remoteData.fixtures.finalChat=parsed.map(p=>({time:new Date().toLocaleTimeString(),scorer:p.scorer,goals:p.goals}));
  saveLocal(remoteData); renderAll(); pushUpdate(remoteData);
}

/* Render fixtures UI */
function renderFixturesUI(fixtures){
  const fixturesDiv=document.getElementById("fixtures");
  const finalsDiv=document.getElementById("finals");
  if(!fixtures || !fixtures.semi){ fixturesDiv.style.display="none"; return; }
  fixturesDiv.style.display="block"; let html="";
  fixtures.semi.forEach((m,idx)=>{
    const scores=fixtures.scores[idx]||[0,0];
    const scorersText=(fixtures.chat[idx]||[]).map(c=>c.scorer+":"+c.goals).join(", ");
    html+=`<div style="margin-bottom:12px">
      <div style="font-weight:700">${escapeHtml(m.team1.name)} <img class="logo" src="${m.team1.logo||''}" onerror="this.style.display='none'"> vs ${escapeHtml(m.team2.name)} <img class="logo" src="${m.team2.logo||''}" onerror="this.style.display='none'"></div>
      <div style="margin-top:6px">Score: <input id="scoreA_${idx}" type="number" min="0" value="${scores[0]}"> - <input id="scoreB_${idx}" type="number" min="0" value="${scores[1]}"></div>
      <label>Scorers list — format: John:2, Mary:1</label>
      <textarea id="scorersList_${idx}" placeholder="e.g. John:2, Mary:1">${escapeHtml(scorersText)}</textarea>
      <div style="margin-top:6px">
        <input id="adminPassMatch_${idx}" type="password" placeholder="Admin password" style="width:60%">
        <button onclick="saveMatch(${idx})">Save Scores & Scorers</button>
      </div>
    </div>`;
  });
  fixturesDiv.innerHTML=html;

  if(fixtures.final){
    const f=fixtures.final; const scores=fixtures.finalScore||[0,0];
    const scorersText=(fixtures.finalChat||[]).map(c=>c.scorer+":"+c.goals).join(", ");
    finalsDiv.innerHTML=`<div style="font-weight:700">${escapeHtml(f.team1.name)} <img class="logo" src="${f.team1.logo||''}" onerror="this.style.display='none'"> vs ${escapeHtml(f.team2.name)} <img class="logo" src="${f.team2.logo||''}" onerror="this.style.display='none'"></div>
      <div style="margin-top:6px">Score: <input id="finalScoreA" type="number" min="0" value="${scores[0]}"> - <input id="finalScoreB" type="number" min="0" value="${scores[1]}"></div>
      <label>Final scorers list</label>
      <textarea id="finalScorersList" placeholder="e.g. John:2, Mary:1">${escapeHtml(scorersText)}</textarea>
      <div style="margin-top:6
